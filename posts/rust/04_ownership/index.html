<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><title>Rust - Basic - 04 - Ownership | KuthorX Blog II</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="RRRR"><meta name=generator content="Hugo 0.148.2"><meta name=robots content="index, follow"><link rel=stylesheet href=/ananke/css/main.min.8d048772ae72ab11245a0e296d1f2a36d3e3dd376c6c867394d6cc659c68fc37.css><link rel=stylesheet href=/css/about.css><link rel="shortcut icon" href=/images/KuthorX-512.webp type=image/x-icon><link rel=canonical href=https://kuthorx.github.io/posts/rust/04_ownership/><meta property="og:url" content="https://kuthorx.github.io/posts/rust/04_ownership/"><meta property="og:site_name" content="KuthorX Blog II"><meta property="og:title" content="Rust - Basic - 04 - Ownership"><meta property="og:description" content="RRRR"><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-01-03T00:00:04+08:00"><meta property="article:modified_time" content="2022-01-03T00:00:04+08:00"><meta itemprop=name content="Rust - Basic - 04 - Ownership"><meta itemprop=description content="RRRR"><meta itemprop=datePublished content="2022-01-03T00:00:04+08:00"><meta itemprop=dateModified content="2022-01-03T00:00:04+08:00"><meta itemprop=wordCount content="866"><meta name=twitter:card content="summary"><meta name=twitter:title content="Rust - Basic - 04 - Ownership"><meta name=twitter:description content="RRRR"></head><body class="ma0 avenir bg-near-white production"><header><div class=bg-black><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l center items-center justify-between"><a href=/ class="f3 fw2 hover-white white-90 dib no-underline">KuthorX Blog II</a><div class="flex-l items-center"><ul class="pl0 mr3"><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white white-90 no-underline" href=/about/ title="About 页">About</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white white-90 no-underline" href=/posts/ title="Posts 页">Posts</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white white-90 no-underline" href=/repos/ title="Repos 页">Repos</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white white-90 no-underline" href=/story_of_cloak/ title="苍绿之眼-故事线 页">苍绿之眼-故事线</a></li></ul><div class=ananke-socials></div></div></div></nav></div></header><main class=pb7 role=main><article class="flex-l mw8 center ph3 flex-wrap justify-between"><header class="mt4 w-100"><aside class="instapaper_ignoref b helvetica tracked ttu">Rust</aside><div id=sharing class="mt3 ananke-socials"></div><h1 class="f1 athelas mt3 mb1">Rust - Basic - 04 - Ownership</h1><time class="f6 mv4 dib tracked" datetime=2022-01-03T00:00:04+08:00>一月 3, 2022</time></header><div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><h1 id=ownership>Ownership</h1><h1 id=comprehension>Comprehension</h1><p>在 Heap 的数据，<code>let b = a;</code> 只会浅拷贝，且此时 <code>a</code> 为 invalid，无法访问（即发生了 move）</p><p>需要写成 <code>let b = a.clone();</code> 才会深拷贝，此时 <code>a</code> 可以访问</p><p>如果函数输入参数类型声明为 <code>String</code> 则会发生浅拷贝（传入值 moved），而如果使用 reference （<code>&amp;String</code>）则不会 moved</p><p>（创建 reference 的过程叫 borrowing）</p><p>如果想要修改 reference 的值，入参需要声明为 <code>&amp;mut String</code></p><p>同一时刻，对同一源数据</p><p>只能有一个 <code>&amp;mut</code> reference 声明（可变），或者</p><p>能有多个 <code>&</code> reference 声明（不可变）。</p><p>不允许：在 reference&rsquo;s scope 范围内，既存在 <code>let &amp;b = a</code> 又存在 <code>let mut &amp;c = a</code>，即无法同时 borrow 不可变 + 可变 reference</p><p>reference 编译时保证 valid，故不会存在 <a href=https://doc.rust-lang.org/book/ch04-02-references-and-borrowing.html#dangling-references>Dangling References</a></p><blockquote><blockquote><p>Rust 有 <em>trait</em> 这个 annotation，暂时不知道是什么</p></blockquote></blockquote><h1 id=origin>Origin</h1><blockquote><p><a href=https://doc.rust-lang.org/book/ch04-00-understanding-ownership.html>https://doc.rust-lang.org/book/ch04-00-understanding-ownership.html</a></p></blockquote><p>&mldr;</p><p>Rust has a special annotation called the <code>Copy</code> trait that we can place on types like integers that are stored on the stack (we’ll talk more about traits in Chapter 10). If a type implements the <code>Copy</code> trait, an older variable is still usable after assignment. Rust won’t let us annotate a type with the <code>Copy</code> trait if the type, or any of its parts, has implemented the <code>Drop</code> trait. If the type needs something special to happen when the value goes out of scope and we add the <code>Copy</code> annotation to that type, we’ll get a compile-time error. To learn about how to add the <code>Copy</code> annotation to your type to implement the trait, see <a href=https://doc.rust-lang.org/book/appendix-03-derivable-traits.html>“Derivable Traits”</a> in Appendix C.</p><p>So what types implement the <code>Copy</code> trait? You can check the documentation for the given type to be sure, but as a general rule, any group of simple scalar values can implement <code>Copy</code>, and nothing that requires allocation or is some form of resource can implement <code>Copy</code>. Here are some of the types that implement <code>Copy</code>:</p><ul><li>All the integer types, such as <code>u32</code>.</li><li>The Boolean type, <code>bool</code>, with values <code>true</code> and <code>false</code>.</li><li>All the floating point types, such as <code>f64</code>.</li><li>The character type, <code>char</code>.</li><li>Tuples, if they only contain types that also implement <code>Copy</code>. For example, <code>(i32, i32)</code> implements <code>Copy</code>, but <code>(i32, String)</code> does not.</li></ul><p>&mldr;</p><p>Filename: src/main.rs</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> s <span style=color:#f92672>=</span> String::from(<span style=color:#e6db74>&#34;hello&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> r1 <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> s;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> r2 <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> s;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>println!</span>(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{}</span><span style=color:#e6db74>, </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#34;</span>, r1, r2);
</span></span></code></pre></div><p>Here’s the error:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>$</span> cargo run
</span></span><span style=display:flex><span>   Compiling ownership v0.<span style=color:#ae81ff>1.0</span> (file:<span style=color:#e6db74>///projects/ownership)
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>error[E0499]: <span style=color:#a6e22e>cannot</span> borrow <span style=color:#960050;background-color:#1e0010>`</span>s<span style=color:#960050;background-color:#1e0010>`</span> <span style=color:#66d9ef>as</span> mutable more than once at a time
</span></span><span style=display:flex><span> <span style=color:#f92672>-</span>-&gt; <span style=color:#a6e22e>src</span><span style=color:#f92672>/</span>main.rs:<span style=color:#ae81ff>5</span>:<span style=color:#ae81ff>14</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>4</span> <span style=color:#f92672>|</span>     <span style=color:#66d9ef>let</span> r1 <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> s;
</span></span><span style=display:flex><span>  <span style=color:#f92672>|</span>              <span style=color:#f92672>------</span> first mutable borrow occurs here
</span></span><span style=display:flex><span><span style=color:#ae81ff>5</span> <span style=color:#f92672>|</span>     <span style=color:#66d9ef>let</span> r2 <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> s;
</span></span><span style=display:flex><span>  <span style=color:#f92672>|</span>              <span style=color:#f92672>^^^^^^</span> second mutable borrow occurs here
</span></span><span style=display:flex><span><span style=color:#ae81ff>6</span> <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>7</span> <span style=color:#f92672>|</span>     <span style=color:#a6e22e>println!</span>(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{}</span><span style=color:#e6db74>, </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#34;</span>, r1, r2);
</span></span><span style=display:flex><span>  <span style=color:#f92672>|</span>                        <span style=color:#f92672>--</span> first borrow later used here
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>For more information about this error, <span style=color:#66d9ef>try</span> <span style=color:#960050;background-color:#1e0010>`</span>rustc <span style=color:#f92672>--</span>explain E0499<span style=color:#960050;background-color:#1e0010>`</span>.
</span></span><span style=display:flex><span>error: <span style=color:#a6e22e>could</span> not compile <span style=color:#960050;background-color:#1e0010>`</span>ownership<span style=color:#960050;background-color:#1e0010>`</span> due to previous error
</span></span></code></pre></div><p>This error says that this code is invalid because we cannot borrow <code>s</code> as mutable more than once at a time. The first mutable borrow is in <code>r1</code> and must last until it’s used in the <code>println!</code>, but between the creation of that mutable reference and its usage, we tried to create another mutable reference in <code>r2</code> that borrows the same data as <code>r1</code>.</p><p>&mldr;</p><p>As always, we can use curly brackets to create a new scope, allowing for multiple mutable references, just not <em>simultaneous</em> ones:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> s <span style=color:#f92672>=</span> String::from(<span style=color:#e6db74>&#34;hello&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> r1 <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> s;
</span></span><span style=display:flex><span>    } <span style=color:#75715e>// r1 goes out of scope here, so we can make a new reference with no problems.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> r2 <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> s;
</span></span></code></pre></div><p>A similar rule exists for combining mutable and immutable references. This code results in an error:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> s <span style=color:#f92672>=</span> String::from(<span style=color:#e6db74>&#34;hello&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> r1 <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>s; <span style=color:#75715e>// no problem
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>let</span> r2 <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>s; <span style=color:#75715e>// no problem
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>let</span> r3 <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> s; <span style=color:#75715e>// BIG PROBLEM
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>println!</span>(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{}</span><span style=color:#e6db74>, </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>, and </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#34;</span>, r1, r2, r3);
</span></span></code></pre></div><p>Here’s the error:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>$</span> cargo run
</span></span><span style=display:flex><span>   Compiling ownership v0.<span style=color:#ae81ff>1.0</span> (file:<span style=color:#e6db74>///projects/ownership)
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>error[E0502]: <span style=color:#a6e22e>cannot</span> borrow <span style=color:#960050;background-color:#1e0010>`</span>s<span style=color:#960050;background-color:#1e0010>`</span> <span style=color:#66d9ef>as</span> mutable because it is also borrowed <span style=color:#66d9ef>as</span> immutable
</span></span><span style=display:flex><span> <span style=color:#f92672>-</span>-&gt; <span style=color:#a6e22e>src</span><span style=color:#f92672>/</span>main.rs:<span style=color:#ae81ff>6</span>:<span style=color:#ae81ff>14</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>4</span> <span style=color:#f92672>|</span>     <span style=color:#66d9ef>let</span> r1 <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>s; <span style=color:#75715e>// no problem
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#f92672>|</span>              <span style=color:#f92672>--</span> immutable borrow occurs here
</span></span><span style=display:flex><span><span style=color:#ae81ff>5</span> <span style=color:#f92672>|</span>     <span style=color:#66d9ef>let</span> r2 <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>s; <span style=color:#75715e>// no problem
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#ae81ff>6</span> <span style=color:#f92672>|</span>     <span style=color:#66d9ef>let</span> r3 <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> s; <span style=color:#75715e>// BIG PROBLEM
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#f92672>|</span>              <span style=color:#f92672>^^^^^^</span> mutable borrow occurs here
</span></span><span style=display:flex><span><span style=color:#ae81ff>7</span> <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>8</span> <span style=color:#f92672>|</span>     <span style=color:#a6e22e>println!</span>(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{}</span><span style=color:#e6db74>, </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>, and </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#34;</span>, r1, r2, r3);
</span></span><span style=display:flex><span>  <span style=color:#f92672>|</span>                                <span style=color:#f92672>--</span> immutable borrow later used here
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>For more information about this error, <span style=color:#66d9ef>try</span> <span style=color:#960050;background-color:#1e0010>`</span>rustc <span style=color:#f92672>--</span>explain E0502<span style=color:#960050;background-color:#1e0010>`</span>.
</span></span><span style=display:flex><span>error: <span style=color:#a6e22e>could</span> not compile <span style=color:#960050;background-color:#1e0010>`</span>ownership<span style=color:#960050;background-color:#1e0010>`</span> due to previous error
</span></span></code></pre></div><p>Whew! We <em>also</em> cannot have a mutable reference while we have an immutable one. Users of an immutable reference don’t expect the values to suddenly change out from under them! However, multiple immutable references are okay because no one who is just reading the data has the ability to affect anyone else’s reading of the data.</p><p>Note that a reference’s scope starts from where it is introduced and continues through the last time that reference is used. For instance, this code will compile because the last usage of the immutable references, the <code>println!</code>, occurs before the mutable reference is introduced:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> s <span style=color:#f92672>=</span> String::from(<span style=color:#e6db74>&#34;hello&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> r1 <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>s; <span style=color:#75715e>// no problem
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>let</span> r2 <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>s; <span style=color:#75715e>// no problem
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>println!</span>(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{}</span><span style=color:#e6db74> and </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#34;</span>, r1, r2);
</span></span><span style=display:flex><span>    <span style=color:#75715e>// variables r1 and r2 will not be used after this point
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> r3 <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> s; <span style=color:#75715e>// no problem
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>println!</span>(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#34;</span>, r3);
</span></span></code></pre></div><p>&mldr;</p><h3 id=the-rules-of-references><a href=https://doc.rust-lang.org/book/ch04-02-references-and-borrowing.html#the-rules-of-references>The Rules of References</a></h3><p>Let’s recap what we’ve discussed about references:</p><ul><li>At any given time, you can have <em>either</em> one mutable reference <em>or</em> any number of immutable references.</li><li>References must always be valid.</li></ul><ul class=pa0></ul><div class="mt6 instapaper_ignoref"></div></div><aside class="w-30-l mt6-l"></aside></article></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white white-70 dn dib-ns pv2 ph3 no-underline" href=https://kuthorx.github.io/>&copy; KuthorX Blog II 2025</a><div><div class=ananke-socials></div></div></div></footer></body></html>